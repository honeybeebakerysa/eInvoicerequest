<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="google-site-verification" content="o74bJo4noiwSjK0-cmRxfwlv0R4pCL7twL_sFpFU1r8" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Makes mobile responsive -->
  <title>HONEYBITES E-Invoice Form</title>
  <style>
    /* Make form container responsive */
    @media (max-width: 768px) {
  #postcode, #city {
    flex: 1 1 100% !important; /* take full width on small screens */
  }
      div[style*="max-width:800px"] {
        max-width: 95% !important;
        margin: 20px auto !important;
        padding: 20px !important;
      }
      h2 { font-size: 18px !important; }
      h3 { font-size: 16px !important; }
      input, select, textarea, button {
        padding: 6px !important;
        font-size: 14px !important;
      }
      button { font-size: 14px !important; padding: 12px !important; }
      .flex, .flex-wrap { flex-direction: column !important; }
      .flex > div { min-width: 100% !important; }
      #sst { width: 100% !important; margin-left: 0 !important; margin-top: 5px !important; }
      #sstNA { margin-top: 10px !important; }
    }
  </style>
</head>
<body>
  <div style="max-width:800px;margin:40px auto;padding:30px;background:#f8f3e9;border-radius:15px;box-shadow:0 4px 20px rgba(0,0,0,0.1);font-family:Arial,sans-serif;line-height:1.6;color:#333;">
    <form id="eInvoiceForm" action="https://script.google.com/macros/s/AKfycbzZ62GZSymHf0TjojqEZryQy8FECnoKN9l3vEVTFDVWg0B6ga1natUnynuc5LDxdWEpdQ/exec" method="POST">
      <!-- Logo + Title -->
      <div style="text-align:center;margin-bottom:25px;">
        <img src="https://i.imgur.com/0lppOV5.png" alt="HONEYBITES Logo" style="max-width:150px;margin-bottom:15px;">
        <h2 style="font-size:22px;color:#222;line-height:1.4;margin:0;">HONEYBITES BAKERY SDN BHD</h2>
        <span style="font-size:18px;color:#444;">E-Invoice Request Application</span>
      </div>

      <!-- Receipt Info -->
      <h3 style="margin:20px 0 10px;color:#444;font-size:18px;">üìÑ Receipt Information</h3>
      <label for="date">Date:</label>
      <input type="text" id="date" name="date" readonly style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ccc;border-radius:6px;">
      <label for="invoice">Invoice No.:</label>
      <input type="text" id="invoice" name="invoice" readonly style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ccc;border-radius:6px;">
      <label for="amount">Amount:</label>
      <input type="text" id="amount" name="amount" readonly style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ccc;border-radius:6px;">
      <label for="terminal">Cashier Terminal:</label>
      <input type="text" id="terminal" name="terminal" readonly style="width:100%;margin-bottom:20px;padding:8px;border:1px solid #ccc;border-radius:6px;">

      <!-- Buyer Info -->
      <h3 style="margin:20px 0 10px;color:#444;font-size:18px;">üßæ Buyer Information</h3>
      <label for="name">Name / Business Name:</label>
      <input type="text" id="name" name="name" required placeholder="FULL NAME / BUSINESS NAME" style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ccc;border-radius:6px;">
      <label for="email">Email:</label>
      <input type="email" id="email" name="email" required placeholder="example@mail.com" style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ccc;border-radius:6px;">
      <label for="classification">Classification:</label>
      <select id="classification" name="classification" required style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ccc;border-radius:6px;">
        <option value="">-- Select --</option>
        <option value="Individual">Individual</option>
        <option value="Business">Business</option>
        <option value="Government">Government</option>
      </select>

      <!-- Dynamic Sections -->
      <div id="tinSection" style="margin-bottom:15px;display:none;">
        <label style="font-weight:600;">Tax Identification Number (TIN): <span style="color:red">*</span></label>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:5px;">
          <label><input type="checkbox" class="tinCheckbox" value="EI00000000010"> EI00000000010 (Malaysian Citizen)</label>
          <label><input type="checkbox" class="tinCheckbox" value="EI00000000020"> EI00000000020 (Non-Malaysian)</label>
          <label><input type="checkbox" class="tinCheckbox" value="EI00000000040"> EI00000000040 (Government)</label>
        </div>
        <textarea id="tinInput" name="tinInput" placeholder="Enter TIN manually" style="width:100%;margin-top:8px;padding:8px;border:1px solid #ccc;border-radius:6px; resize: none;"></textarea>
      </div>

      <div id="identitySection" style="margin-bottom:15px;display:none;">
        <label for="identityType">Identity:</label>
        <select id="identityType" name="identityType" style="width:100%;margin-bottom:8px;padding:8px;border:1px solid #ccc;border-radius:6px;">
          <option value="">-- Select --</option>
          <option value="MyKad">MyKad</option>
          <option value="MyPR">MyPR</option>
          <option value="MyKAS">MyKAS</option>
          <option value="Army">Army</option>
          <option value="Passport">Passport</option>
        </select>
        <input type="text" id="identityValue" name="identityValue" placeholder="Identity No." style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
      </div>

      <div id="brnSection" style="margin-bottom:15px;display:none;">
        <label for="brn">Business Registration Number (BRN):</label>
        <input type="text" id="brn" name="brn" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
      </div>

      <div id="sstSection" style="margin-bottom:15px;display:none;">
        <label for="sst">SST Registration Number:</label><br>
        <input type="checkbox" id="sstNA"> N/A
        <input type="text" id="sst" name="sst" style="width:calc(100% - 60px);margin-left:10px;padding:8px;border:1px solid #ccc;border-radius:6px;">
      </div>

      <label for="contact">Contact Number:</label>
      <input type="text" id="contact" name="contact" required placeholder="e.g. 0123456789" style="width:100%;margin-bottom:12px;padding:8px;border:1px solid #ccc;border-radius:6px;">

      <!-- Address Section -->
      <label>Address:</label>
      <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:15px;">
        <textarea id="address1" name="address1" required placeholder="Address Line 1" style="width:100%;height:50px;resize:none;padding:8px;border:1px solid #ccc;border-radius:6px;"></textarea>
        <textarea id="address2" name="address2" placeholder="Address Line 2" style="width:100%;height:50px;resize:none;padding:8px;border:1px solid #ccc;border-radius:6px;"></textarea>
        <textarea id="address3" name="address3" placeholder="Address Line 3" style="width:100%;height:50px;resize:none;padding:8px;border:1px solid #ccc;border-radius:6px;"></textarea>
      </div>

      <div style="display:flex;flex-wrap:wrap;gap:15px;margin-bottom:15px;">
  <div style="flex:1;min-width:140px;">
    <label for="postcode" style="display:block;margin-bottom:5px;">Postcode:</label>
    <input type="number" id="postcode" name="postcode" required
           style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;">
  </div>
  
  <div style="flex:2;min-width:200px;">
    <label for="city" style="display:block;margin-bottom:5px;">City:</label>
    <input type="text" id="city" name="city" required
           style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;">
  </div>
      </div>

      <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;">
        <div style="flex:1;min-width:180px;">
          <label>State:</label>
          <select id="state" name="state" required style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
            <option value="">-- Select --</option>
            <option value="Sarawak">Sarawak</option>
            <option value="Sabah">Sabah</option>
            <option value="Johor">Johor</option>
            <option value="Kedah">Kedah</option>
            <option value="Kelantan">Kelantan</option>
            <option value="Melaka">Melaka</option>
            <option value="Negeri Sembilan">Negeri Sembilan</option>
            <option value="Pahang">Pahang</option>
            <option value="Penang">Penang</option>
            <option value="Perak">Perak</option>
            <option value="Perlis">Perlis</option>
            <option value="Selangor">Selangor</option>
            <option value="Terengganu">Terengganu</option>
            <option value="Kuala Lumpur">Kuala Lumpur</option>
            <option value="Putrajaya">Putrajaya</option>
            <option value="Labuan">Labuan</option>
          </select>
        </div>
        <div style="flex:1;min-width:180px;">
          <label>Country:</label>
          <select id="country" name="country" required style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
            <option value="Malaysia">Malaysia</option>
            <option value="Afghanistan">Afghanistan</option>
  <option value="Albania">Albania</option>
  <option value="Algeria">Algeria</option>
  <option value="Andorra">Andorra</option>
  <option value="Angola">Angola</option>
  <option value="Antigua and Barbuda">Antigua and Barbuda</option>
  <option value="Argentina">Argentina</option>
  <option value="Armenia">Armenia</option>
  <option value="Australia">Australia</option>
  <option value="Austria">Austria</option>
  <option value="Azerbaijan">Azerbaijan</option>
  <option value="Bahamas">Bahamas</option>
  <option value="Bahrain">Bahrain</option>
  <option value="Bangladesh">Bangladesh</option>
  <option value="Barbados">Barbados</option>
  <option value="Belarus">Belarus</option>
  <option value="Belgium">Belgium</option>
  <option value="Belize">Belize</option>
  <option value="Benin">Benin</option>
  <option value="Bhutan">Bhutan</option>
  <option value="Bolivia">Bolivia</option>
  <option value="Bosnia and Herzegovina">Bosnia and Herzegovina</option>
  <option value="Botswana">Botswana</option>
  <option value="Brazil">Brazil</option>
  <option value="Brunei">Brunei</option>
  <option value="Bulgaria">Bulgaria</option>
  <option value="Burkina Faso">Burkina Faso</option>
  <option value="Burundi">Burundi</option>
  <option value="Cabo Verde">Cabo Verde</option>
  <option value="Cambodia">Cambodia</option>
  <option value="Cameroon">Cameroon</option>
  <option value="Canada">Canada</option>
  <option value="Central African Republic">Central African Republic</option>
  <option value="Chad">Chad</option>
  <option value="Chile">Chile</option>
  <option value="China">China</option>
  <option value="Colombia">Colombia</option>
  <option value="Comoros">Comoros</option>
  <option value="Congo, Democratic Republic of the">Congo, Democratic Republic of the</option>
  <option value="Congo, Republic of the">Congo, Republic of the</option>
  <option value="Costa Rica">Costa Rica</option>
  <option value="Croatia">Croatia</option>
  <option value="Cuba">Cuba</option>
  <option value="Cyprus">Cyprus</option>
  <option value="Czechia">Czechia</option>
  <option value="Denmark">Denmark</option>
  <option value="Djibouti">Djibouti</option>
  <option value="Dominica">Dominica</option>
  <option value="Dominican Republic">Dominican Republic</option>
  <option value="Ecuador">Ecuador</option>
  <option value="Egypt">Egypt</option>
  <option value="El Salvador">El Salvador</option>
  <option value="Equatorial Guinea">Equatorial Guinea</option>
  <option value="Eritrea">Eritrea</option>
  <option value="Estonia">Estonia</option>
  <option value="Eswatini">Eswatini</option>
  <option value="Ethiopia">Ethiopia</option>
  <option value="Fiji">Fiji</option>
  <option value="Finland">Finland</option>
  <option value="France">France</option>
  <option value="Gabon">Gabon</option>
  <option value="Gambia">Gambia</option>
  <option value="Georgia">Georgia</option>
  <option value="Germany">Germany</option>
  <option value="Ghana">Ghana</option>
  <option value="Greece">Greece</option>
  <option value="Grenada">Grenada</option>
  <option value="Guatemala">Guatemala</option>
  <option value="Guinea">Guinea</option>
  <option value="Guinea-Bissau">Guinea-Bissau</option>
  <option value="Guyana">Guyana</option>
  <option value="Haiti">Haiti</option>
  <option value="Honduras">Honduras</option>
  <option value="Hungary">Hungary</option>
  <option value="Iceland">Iceland</option>
  <option value="India">India</option>
  <option value="Indonesia">Indonesia</option>
  <option value="Iran">Iran</option>
  <option value="Iraq">Iraq</option>
  <option value="Ireland">Ireland</option>
  <option value="Israel">Israel</option>
  <option value="Italy">Italy</option>
  <option value="Jamaica">Jamaica</option>
  <option value="Japan">Japan</option>
  <option value="Jordan">Jordan</option>
  <option value="Kazakhstan">Kazakhstan</option>
  <option value="Kenya">Kenya</option>
  <option value="Kiribati">Kiribati</option>
  <option value="Korea, North">Korea, North</option>
  <option value="Korea, South">Korea, South</option>
  <option value="Kuwait">Kuwait</option>
  <option value="Kyrgyzstan">Kyrgyzstan</option>
  <option value="Laos">Laos</option>
  <option value="Latvia">Latvia</option>
  <option value="Lebanon">Lebanon</option>
  <option value="Lesotho">Lesotho</option>
  <option value="Liberia">Liberia</option>
  <option value="Libya">Libya</option>
  <option value="Liechtenstein">Liechtenstein</option>
  <option value="Lithuania">Lithuania</option>
  <option value="Luxembourg">Luxembourg</option>
  <option value="Madagascar">Madagascar</option>
  <option value="Malawi">Malawi</option>
  <option value="Maldives">Maldives</option>
  <option value="Mali">Mali</option>
  <option value="Malta">Malta</option>
  <option value="Marshall Islands">Marshall Islands</option>
  <option value="Mauritania">Mauritania</option>
  <option value="Mauritius">Mauritius</option>
  <option value="Mexico">Mexico</option>
  <option value="Micronesia">Micronesia</option>
  <option value="Moldova">Moldova</option>
  <option value="Monaco">Monaco</option>
  <option value="Mongolia">Mongolia</option>
  <option value="Montenegro">Montenegro</option>
  <option value="Morocco">Morocco</option>
  <option value="Mozambique">Mozambique</option>
  <option value="Myanmar">Myanmar</option>
  <option value="Namibia">Namibia</option>
  <option value="Nauru">Nauru</option>
  <option value="Nepal">Nepal</option>
  <option value="Netherlands">Netherlands</option>
  <option value="New Zealand">New Zealand</option>
  <option value="Nicaragua">Nicaragua</option>
  <option value="Niger">Niger</option>
  <option value="Nigeria">Nigeria</option>
  <option value="North Macedonia">North Macedonia</option>
  <option value="Norway">Norway</option>
  <option value="Oman">Oman</option>
  <option value="Pakistan">Pakistan</option>
  <option value="Palau">Palau</option>
  <option value="Palestine">Palestine</option>
  <option value="Panama">Panama</option>
  <option value="Papua New Guinea">Papua New Guinea</option>
  <option value="Paraguay">Paraguay</option>
  <option value="Peru">Peru</option>
  <option value="Philippines">Philippines</option>
  <option value="Poland">Poland</option>
  <option value="Portugal">Portugal</option>
  <option value="Qatar">Qatar</option>
  <option value="Romania">Romania</option>
  <option value="Russia">Russia</option>
  <option value="Rwanda">Rwanda</option>
  <option value="Saint Kitts and Nevis">Saint Kitts and Nevis</option>
  <option value="Saint Lucia">Saint Lucia</option>
  <option value="Saint Vincent and the Grenadines">Saint Vincent and the Grenadines</option>
  <option value="Samoa">Samoa</option>
  <option value="San Marino">San Marino</option>
  <option value="Sao Tome and Principe">Sao Tome and Principe</option>
  <option value="Saudi Arabia">Saudi Arabia</option>
  <option value="Senegal">Senegal</option>
  <option value="Serbia">Serbia</option>
  <option value="Seychelles">Seychelles</option>
  <option value="Sierra Leone">Sierra Leone</option>
  <option value="Singapore">Singapore</option>
  <option value="Slovakia">Slovakia</option>
  <option value="Slovenia">Slovenia</option>
  <option value="Solomon Islands">Solomon Islands</option>
  <option value="Somalia">Somalia</option>
  <option value="South Africa">South Africa</option>
  <option value="South Sudan">South Sudan</option>
  <option value="Spain">Spain</option>
  <option value="Sri Lanka">Sri Lanka</option>
  <option value="Sudan">Sudan</option>
  <option value="Suriname">Suriname</option>
  <option value="Sweden">Sweden</option>
  <option value="Switzerland">Switzerland</option>
  <option value="Syria">Syria</option>
  <option value="Taiwan">Taiwan</option>
  <option value="Tajikistan">Tajikistan</option>
  <option value="Tanzania">Tanzania</option>
  <option value="Thailand">Thailand</option>
  <option value="Timor-Leste">Timor-Leste</option>
  <option value="Togo">Togo</option>
  <option value="Tonga">Tonga</option>
  <option value="Trinidad and Tobago">Trinidad and Tobago</option>
  <option value="Tunisia">Tunisia</option>
  <option value="Turkey">Turkey</option>
  <option value="Turkmenistan">Turkmenistan</option>
  <option value="Tuvalu">Tuvalu</option>
  <option value="Uganda">Uganda</option>
  <option value="Ukraine">Ukraine</option>
  <option value="United Arab Emirates">United Arab Emirates</option>
  <option value="United Kingdom">United Kingdom</option>
  <option value="United States">United States</option>
  <option value="Uruguay">Uruguay</option>
  <option value="Uzbekistan">Uzbekistan</option>
  <option value="Vanuatu">Vanuatu</option>
  <option value="Vatican City">Vatican City</option>
  <option value="Venezuela">Venezuela</option>
  <option value="Vietnam">Vietnam</option>
  <option value="Yemen">Yemen</option>
  <option value="Zambia">Zambia</option>
  <option value="Zimbabwe">Zimbabwe</option>
            <option value="Other">Other</option>
          </select>
        </div>
      </div>

      <!-- Clarification -->
      <div style="margin:15px 0;">
        <label style="font-size:14px;color:#444;">
          <input type="checkbox" id="confirm" required> I confirm that the above information is correct.
        </label>
      </div>

      <!-- Submit -->
      <button type="submit" style="width:100%;padding:14px;background:#4a2f00;color:#fff;font-weight:bold;border:none;border-radius:8px;cursor:pointer;font-size:16px;transition:0.3s;">
        Submit
      </button>
      <div id="formStatus" style="margin-top:12px;font-weight:bold;color:#444;"></div>
    </form>
  </div>

<script>
window.onload = function() {
  // --------------------------
  // URL parameters
  // --------------------------
  const params = new URLSearchParams(window.location.search);
  const dateParam = params.get("date");
  const receiptParam = params.get("receipt");
  const totalParam = params.get("total");

  const date = dateParam ? decodeURIComponent(dateParam) : "";
  const receipt = receiptParam ? decodeURIComponent(receiptParam) : "";
  const total = totalParam ? decodeURIComponent(totalParam) : "";

  // Define form + global disable flag
  const form = document.getElementById("eInvoiceForm");
  let formDisabled = false;

  // Autofill receipt details (readonly)
  const dateEl = document.getElementById("date");
  const invoiceEl = document.getElementById("invoice");
  const amountEl = document.getElementById("amount");
  if(dateEl) dateEl.value = date.replace(/-/g, "/");
  if(invoiceEl) invoiceEl.value = receipt;
  if(amountEl) amountEl.value = "RM " + total;

  // Terminal auto-select (readonly)
  const terminalSelect = document.getElementById("terminal");
  if(terminalSelect && receipt){
    if(receipt.includes("T01")) terminalSelect.value = "T-01 (Pasar Counter 1)";
    else if(receipt.includes("T02")) terminalSelect.value = "T-02 (Pasar Counter 2)";
    else if(receipt.includes("T04")) terminalSelect.value = "T-04 (Lian Yi Counter)";
  }

// --------------------------
// Duplicate Receipt Check (run AFTER autofill)
// --------------------------
if (invoiceEl && invoiceEl.value) {
  console.log("Checking receipt:", invoiceEl.value); // debug log

  fetch("https://script.google.com/macros/s/AKfycbzZ62GZSymHf0TjojqEZryQy8FECnoKN9l3vEVTFDVWg0B6ga1natUnynuc5LDxdWEpdQ/exec")
    .then(res => res.json())
    .then(existingReceipts => {
      console.log("Receipts from sheet:", existingReceipts); // debug log

      const normalizedReceipts = existingReceipts.map(r => r.toString().trim().toUpperCase());
      if (normalizedReceipts.includes(invoiceEl.value.trim().toUpperCase())) {
        // Disable form
        [...form.querySelectorAll("input, select, textarea, button")].forEach(el => el.disabled = true);
        formDisabled = true; // <-- mark disabled globally

        // Show message
        const msgBox = document.createElement("div");
        msgBox.innerText = "‚úÖ The Receipt already submitted for E-Invoice.";
        msgBox.style.backgroundColor = "#ddffdd";
        msgBox.style.color = "#006400";
        msgBox.style.padding = "12px";
        msgBox.style.border = "1px solid #006400";
        msgBox.style.borderRadius = "8px";
        msgBox.style.marginBottom = "15px";
        msgBox.style.fontWeight = "bold";
        msgBox.style.textAlign = "center";
        form.parentNode.insertBefore(msgBox, form);
      }

      // ‚úÖ Always run date validation after checking duplicate
      runDateValidation();
    })
    .catch(err => {
      console.error("Error checking receipts:", err);
      runDateValidation(); // still run date validation even if fetch fails
    });
} else {
  // No invoice number, just run date validation
  runDateValidation();
}

  // --------------------------
  // Receipt Date Validation (wrapped in function)
  // --------------------------
  function runDateValidation() {
    if (formDisabled) return; // skip if already disabled earlier
    
    if(dateEl && dateEl.value){
    // URL provides YYYY-MM-DD, split by "-" or "/"
    const parts = dateEl.value.includes("-") ? dateEl.value.split("-") : dateEl.value.split("/");
    const [year, month, day] = parts;
    const receiptDate = new Date(`${year}-${month}-${day}`);

    // Move to first of next month to avoid end-of-month rollover issues
    const nextMonthFirst = new Date(receiptDate.getFullYear(), receiptDate.getMonth() + 1, 1);

    // Cutoff = 3rd of next month
    const cutoffDate = new Date(nextMonthFirst.getFullYear(), nextMonthFirst.getMonth(), 3);

    const today = new Date();

    if(today > cutoffDate){
      formDisabled = true;

      // Disable all form elements
      [...form.querySelectorAll("input, select, textarea, button")].forEach(el => el.disabled = true);

      // Show warning message
      const msgBox = document.createElement("div");
      msgBox.innerText = "‚ö†Ô∏è Receipt has been submitted on the 3rd date of following month.";
      msgBox.style.backgroundColor = "#ffdddd";
      msgBox.style.color = "#d8000c";
      msgBox.style.padding = "12px";
      msgBox.style.border = "1px solid #d8000c";
      msgBox.style.borderRadius = "8px";
      msgBox.style.marginBottom = "15px";
      msgBox.style.fontWeight = "bold";
      msgBox.style.textAlign = "center";
      form.parentNode.insertBefore(msgBox, form);
    }

    // Format input to YYYY/MM/DD for display only
    dateEl.value = `${year}/${month}/${day}`;
  }
}

  // --------------------------
  // Input formatting helpers
  // --------------------------
  const formatUpperSingleSpace = el => el.addEventListener("input", function(){
    this.value = this.value.toUpperCase().replace(/\s+/g," ").trimStart();
  });
  const formatLowerNoSpace = el => el.addEventListener("input", function(){
    this.value = this.value.toLowerCase().replace(/\s+/g,"");
  });
  const formatNumberSymbolsOnly = el => el.addEventListener("input", function(){
    this.value = this.value.replace(/[^0-9+()-]/g,"");
  });

  formatUpperSingleSpace(document.getElementById("name"));
  formatLowerNoSpace(document.getElementById("email"));
  formatUpperSingleSpace(document.getElementById("identityValue"));
  formatUpperSingleSpace(document.getElementById("brn"));
  formatNumberSymbolsOnly(document.getElementById("contact"));
  ["address1","address2","address3"].forEach(id => formatUpperSingleSpace(document.getElementById(id)));
  const city = document.getElementById("city");
  city.addEventListener("input", function(){
    this.value = this.value.toUpperCase().replace(/\s+/g," ").trimStart().replace(/[^A-Z\s]/g,"");
  });
  document.getElementById("postcode").addEventListener("input", function(){
    this.value = this.value.replace(/\D/g,"");
  });

  // --------------------------
  // TIN & Classification
  // --------------------------
  const tinInput = document.getElementById("tinInput");
  const tinSection = document.getElementById("tinSection");
  const classification = document.getElementById("classification");
  const tinCheckboxes = tinSection.querySelectorAll(".tinCheckbox");

// keep textarea tidy
tinInput.style.resize = "none";
formatUpperSingleSpace(tinInput); 
tinInput.readOnly = false; // allow typing initially

  tinCheckboxes.forEach(cb => {
    cb.addEventListener("change", function(){
      if(this.checked){
        tinCheckboxes.forEach(other => { if(other!==this) other.checked=false; });
        tinInput.value = this.value;
        tinInput.readOnly = true;
      } else {
        if(![...tinCheckboxes].some(c => c.checked)){
          tinInput.value = "";
          tinInput.readOnly = false;
        }
      }
    });
  });

  classification.addEventListener("change", function(){
    const identitySection = document.getElementById("identitySection");
    const brnSection = document.getElementById("brnSection");
    const sstSection = document.getElementById("sstSection");
    const sstNA = document.getElementById("sstNA");

    // Reset all sections
    tinSection.style.display = "none";
    identitySection.style.display = "none";
    brnSection.style.display = "none";
    sstSection.style.display = "none";

    tinInput.value = "";
    tinInput.disabled = false;
    tinCheckboxes.forEach(c => c.checked = false);
    if(sstNA) sstNA.checked = false;

    if(this.value==="Business"){
      tinSection.style.display="block";
      brnSection.style.display="block";
      sstSection.style.display="block";
    } else if(this.value==="Government"){
      tinSection.style.display="block";
    } else if(this.value==="Individual"){
      tinSection.style.display="block";
      identitySection.style.display="block";
    }
  });

  // SST N/A logic
  const sstInput = document.getElementById("sst");
  const sstNA = document.getElementById("sstNA");
  if(sstNA && sstInput){
    sstNA.addEventListener("change", function(){
      if(this.checked){
        sstInput.disabled = true;
        sstInput.value = "";
      } else {
        sstInput.disabled = false;
      }
    });
  }

  // --------------------------
  // State / Country logic
  // --------------------------
  const country = document.getElementById("country");
  country.addEventListener("change", function(){
    const stateContainer = document.getElementById("state");
    if(this.value==="Malaysia"){
      stateContainer.outerHTML = `
        <select id="state" name="state" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;margin-bottom:12px;" required>
          <option value="">-- Select --</option>
          <option value="Sarawak">Sarawak</option>
          <option value="Sabah">Sabah</option>
          <option value="Johor">Johor</option>
          <option value="Kedah">Kedah</option>
          <option value="Kelantan">Kelantan</option>
          <option value="Melaka">Melaka</option>
          <option value="Negeri Sembilan">Negeri Sembilan</option>
          <option value="Pahang">Pahang</option>
          <option value="Penang">Penang</option>
          <option value="Perak">Perak</option>
          <option value="Perlis">Perlis</option>
          <option value="Selangor">Selangor</option>
          <option value="Terengganu">Terengganu</option>
          <option value="Kuala Lumpur">Kuala Lumpur</option>
          <option value="Putrajaya">Putrajaya</option>
          <option value="Labuan">Labuan</option>
        </select>`;
    } else {
      stateContainer.outerHTML = `
      <input type="text" id="state" name="state"
        style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;margin-bottom:12px;"
        placeholder="Enter State" required>`;
    }
  });

  // --------------------------
  // Form submission
  // --------------------------
  const formStatus = document.getElementById("formStatus");

  form.addEventListener("submit", function(e){
    e.preventDefault(); // prevent default

    formStatus.innerText = ""; // clear previous
    formStatus.style.color = "#5bc0de";

    // Stop if form disabled
    if(formDisabled){
      formStatus.innerText = "‚ö†Ô∏è Form cannot be submitted: receipt is past cutoff date.";
      formStatus.style.color = "#d8000c";
      return;
    }

    // Required fields check (only visible sections)
    let missingFields = [];
    const requiredFields = form.querySelectorAll("input[required], select[required], textarea[required]");
    requiredFields.forEach(el => {
      if(el.offsetParent !== null && !el.value.trim()) missingFields.push(el.id);
    });

// BRN required if visible
const brnField = document.getElementById("brn");
const brnSection = document.getElementById("brnSection");
if(brnSection && brnSection.style.display !== "none" && brnField && !brnField.value.trim()){
  missingFields.push("brn");
}

// SST required if visible and N/A not checked
const sstField = document.getElementById("sst");
const sstNA = document.getElementById("sstNA");
const sstSection = document.getElementById("sstSection");
if(sstSection && sstSection.style.display !== "none" && sstField && !sstNA.checked && !sstField.value.trim()){
  missingFields.push("sst");
}

// TIN required if visible
const tinSection = document.getElementById("tinSection");
const tinInput = document.getElementById("tinInput");
const tinCheckboxes = tinSection.querySelectorAll(".tinCheckbox");

if(tinSection && tinSection.style.display !== "none"){
  // Require either checkbox selected OR manual input filled
  const checkboxChecked = [...tinCheckboxes].some(cb => cb.checked);
  const tinFilled = tinInput && tinInput.value.trim() !== "";
  if(!checkboxChecked && !tinFilled){
    missingFields.push("tin"); // will trigger "Please fill all required fields"
  }
}

// Identity required if visible
const identitySection = document.getElementById("identitySection");
const identityType = document.getElementById("identityType");
const identityValue = document.getElementById("identityValue");

if(identitySection && identitySection.style.display !== "none"){
  if(!identityType.value.trim() || !identityValue.value.trim()){
    missingFields.push("identity"); // triggers "Please fill all required fields"
  }
}

// Receipt Information required if visible
const dateEl = document.getElementById("date");
const invoiceEl = document.getElementById("invoice");
const amountEl = document.getElementById("amount");
const terminalEl = document.getElementById("terminal");

if(dateEl && dateEl.offsetParent !== null && !dateEl.value.trim()) missingFields.push("date");
if(invoiceEl && invoiceEl.offsetParent !== null && !invoiceEl.value.trim()) missingFields.push("invoice");
if(amountEl && amountEl.offsetParent !== null && !amountEl.value.trim()) missingFields.push("amount");
if(terminalEl && terminalEl.offsetParent !== null && !terminalEl.value.trim()) missingFields.push("terminal");

    if(missingFields.length > 0){
      formStatus.innerText = "‚ö†Ô∏è Please fill all required fields.";
      formStatus.style.color = "#d8000c";
      return;
    }

    // Show submitting
    formStatus.innerText = "Submitting form...";
    formStatus.style.color = "#5bc0de";

    const formData = new FormData(form);
    fetch(form.action, { method: "POST", body: formData })
      .then(response => {
        if(response.ok){
          formStatus.innerText = "‚úÖ Form submitted successfully!";
          formStatus.style.color = "#28a745";
          form.reset();
        } else {
          formStatus.innerText = "‚ö†Ô∏è Submission failed. Please try again.";
          formStatus.style.color = "#d8000c";
        }
      })
      .catch(err => {
        formStatus.innerText = "‚ö†Ô∏è Submission error. Please check your connection.";
        formStatus.style.color = "#d8000c";
      });

  });
};
</script>
</body>
</html>











